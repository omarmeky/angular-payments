angular.module("angularPayments",[]),angular.module("angularPayments").factory("Common",[function(){var e={};return e.parseExpiry=function(e){var t,r,n,a;return e=e||"",e=e.replace(/\s/g,""),a=e.split("/",2),t=a[0],n=a[1],2===(null!=n?n.length:void 0)&&/^\d+$/.test(n)&&(r=(new Date).getFullYear(),r=r.toString().slice(0,2),n=r+n),t=parseInt(t,10),n=parseInt(n,10),{month:t,year:n}},e}]),angular.module("angularPayments").factory("Cards",[function(){var e=/(\d{1,4})/g,t=/(?:^|\s)(\d{4})$/,r=[{type:"discover",pattern:/^(6011|65|64[4-9]|622)/,format:e,inputFormat:t,length:[16],cvcLength:[3],luhn:!0},{type:"mastercard",pattern:/^5[1-5]/,format:e,inputFormat:t,length:[16],cvcLength:[3],luhn:!0},{type:"amex",pattern:/^3[47]/,format:/(\d{1,4})(\d{1,6})?(\d{1,5})?/,inputFormat:/^(\d{4}|\d{4}\s\d{6})$/,length:[15],cvcLength:[3,4],luhn:!0},{type:"visa",pattern:/^4/,format:e,inputFormat:t,length:[13,14,15,16],cvcLength:[3],luhn:!0}],n=function(e){var t,n,a;for(e=(e+"").replace(/\D/g,""),n=0,a=r.length;a>n;n++)if(t=r[n],t.pattern.test(e))return t},a=function(e){var t,n,a;for(n=0,a=r.length;a>n;n++)if(t=r[n],t.type===e)return t};return{fromNumber:function(e){return n(e)},fromType:function(e){return a(e)},defaultFormat:function(){return e},defaultInputFormat:function(){return t}}}]),angular.module("angularPayments").factory("_Format",["Cards","Common","$filter",function(e,t,r){var n={},a=function(e){var t;return null!=e.prop("selectionStart")&&e.prop("selectionStart")!==e.prop("selectionEnd")?!0:("undefined"!=typeof document&&null!==document&&null!=(t=document.selection)&&"function"==typeof t.createRange?t.createRange().text:void 0)?!0:!1},o=function(t){var r,n,a,o,l,i,u;if(a=String.fromCharCode(t.which),r=angular.element(t.currentTarget),u=r.val(),n=e.fromNumber(u+a),o=(u.replace(/\D/g,"")+a).length,i=16,n&&(i=n.length[n.length.length-1]),!(o>=i)){if(!/^\d+$/.test(a)&&!t.meta&&t.keyCode>=46)return void t.preventDefault();if(null==r.prop("selectionStart")||r.prop("selectionStart")===u.length)return l=e.defaultInputFormat(),n&&(l=n.inputFormat),l.test(u)?(t.preventDefault(),r.val(u+" "+a)):l.test(u+a)?(t.preventDefault(),r.val(u+a+" ")):void 0}},l=function(t){var r,n,o,l;r=angular.element(t.currentTarget),o=String.fromCharCode(t.which),/^\d+$/.test(o)&&(a(r)||(l=(r.val()+o).replace(/\D/g,""),n=e.fromNumber(l),n?l.length<=n.length[n.length.length-1]||t.preventDefault():l.length<=16||t.preventDefault()))},i=function(e){var t,r;return t=angular.element(e.currentTarget),r=t.val(),e.meta||8!==e.which||null!=t.prop("selectionStart")&&t.prop("selectionStart")!==r.length?void 0:/\d\s$/.test(r)&&!e.meta&&e.keyCode>=46?(e.preventDefault(),t.val(r.replace(/\d\s$/,""))):/\s\d?$/.test(r)?(e.preventDefault(),t.val(r.replace(/\s\d?$/,""))):void 0},u=function(t){var r,n,a,o;return(r=e.fromNumber(t))?(a=r.length[r.length.length-1],t=t.replace(/\D/g,""),t=t.slice(0,+a+1||9e9),r.format.global?null!=(o=t.match(r.format))?o.join(" "):void 0:(n=r.format.exec(t),null!=n&&n.shift(),null!=n?n.join(" "):void 0)):t},s=function(e){return setTimeout(function(){var t,r;return t=angular.element(e.target),r=t.val(),r=u(r),t.val(r)})},p=function(e){return null!=e?e.replace(/\s/g,""):e};n.card=function(e,t){e.bind("keypress",l),e.bind("keypress",o),e.bind("keydown",i),e.bind("paste",s),t.$parsers.push(p),t.$formatters.push(u)},_formatCVC=function(e){return $target=angular.element(e.currentTarget),digit=String.fromCharCode(e.which),!/^\d+$/.test(digit)&&!e.meta&&e.keyCode>=46?void e.preventDefault():(val=$target.val()+digit,val.length<=4?void 0:void e.preventDefault())},n.cvc=function(e){e.bind("keypress",_formatCVC)},_restrictExpiry=function(e){var t,r,n;return t=angular.element(e.currentTarget),r=String.fromCharCode(e.which),!/^\d+$/.test(r)&&!e.meta&&e.keyCode>=46?void e.preventDefault():a(t)?void 0:(n=t.val()+r,n=n.replace(/\D/g,""),n.length>6?void e.preventDefault():void 0)},_formatExpiry=function(e){var t,r,n;return r=String.fromCharCode(e.which),!/^\d+$/.test(r)&&!e.meta&&e.keyCode>=46?void e.preventDefault():(t=angular.element(e.currentTarget),n=t.val()+r,/^\d$/.test(n)&&"0"!==n&&"1"!==n?(e.preventDefault(),t.val("0"+n+" / ")):/^\d\d$/.test(n)?(e.preventDefault(),t.val(""+n+" / ")):void 0)},_formatForwardExpiry=function(e){var t,r,n;return r=String.fromCharCode(e.which),!/^\d+$/.test(r)&&!e.meta&&e.keyCode>=46?void 0:(t=angular.element(e.currentTarget),n=t.val(),/^\d\d$/.test(n)?t.val(""+n+" / "):void 0)},_formatForwardSlash=function(e){var t,r,n;return r=String.fromCharCode(e.which),"/"===r?(t=angular.element(e.currentTarget),n=t.val(),/^\d$/.test(n)&&"0"!==n?t.val("0"+n+" / "):void 0):void 0},_formatBackExpiry=function(e){var t,r;if(!e.meta&&(t=angular.element(e.currentTarget),r=t.val(),8===e.which&&(null==t.prop("selectionStart")||t.prop("selectionStart")===r.length)))return/\d(\s|\/)+$/.test(r)?(e.preventDefault(),t.val(r.replace(/\d(\s|\/)*$/,""))):/\s\/\s?\d?$/.test(r)?(e.preventDefault(),t.val(r.replace(/\s\/\s?\d?$/,""))):void 0};var d=function(e){if(null!=e){var n=t.parseExpiry(e),a=new Date(n.year,n.month-1);return r("date")(a,"MM/yyyy")}return null},c=function(e){if(null!=e){var n=t.parseExpiry(e),a=new Date(n.year,n.month-1);return r("date")(a,"MM / yyyy")}return null};return n.expiry=function(e,t){e.bind("keypress",_restrictExpiry),e.bind("keypress",_formatExpiry),e.bind("keypress",_formatForwardSlash),e.bind("keypress",_formatForwardExpiry),e.bind("keydown",_formatBackExpiry),t.$parsers.push(d),t.$formatters.push(c)},function(e,t,r){if(!n[e])throw types=Object.keys(n),errstr='Unknown type for formatting: "'+e+'". ',errstr+='Should be one of: "'+types.join('", "')+'"',errstr;return n[e](t,r)}}]).directive("paymentsFormat",["$window","_Format",function(e,t){return{restrict:"A",require:"ngModel",link:function(e,r,n,a){t(n.paymentsFormat,r,a)}}}]),angular.module("angularPayments").factory("_Validate",["Cards","Common","$parse",function(e,t,r){var n=[].indexOf||function(e){for(var t=0,r=this.length;r>t;t++)if(t in this&&this[t]===e)return t;return-1},a=function(e){var t,r,n,a,o,l;for(n=!0,a=0,r=(e+"").split("").reverse(),o=0,l=r.length;l>o;o++)t=r[o],t=parseInt(t,10),(n=!n)&&(t*=2),t>9&&(t-=9),a+=t;return a%10===0},o={};return o.cvc=function(t,a,o,l){var i,u;if(null==t||0==t.length)return!0;if(!/^\d+$/.test(t))return!1;var s;if(l.paymentsTypeModel){var p=r(l.paymentsTypeModel);s=p(o)}return s?(i=t.length,n.call(null!=(u=e.fromType(s))?u.cvcLength:void 0,i)>=0):t.length>=3&&t.length<=4},o.card=function(t,o,l,i){var u,s,p;i.paymentsTypeModel&&(p=r(i.paymentsTypeModel));var d=function(){p&&p.assign(l,null),o.$card=null};return null==t||0==t.length?(d(),!0):(t=(t+"").replace(/\s+|-/g,""),/^\d+$/.test(t)&&(u=e.fromNumber(t))?(o.$card=angular.copy(u),p&&p.assign(l,u.type),ret=(s=t.length,n.call(u.length,s)>=0&&(u.luhn===!1||a(t))),ret):(d(),!1))},o.expiry=function(e){if(null==e||0==e.length)return!0;obj=t.parseExpiry(e),month=obj.month,year=obj.year;var r,n,a;return month&&year&&/^\d+$/.test(month)&&/^\d+$/.test(year)&&parseInt(month,10)<=12?(2===year.length&&(a=(new Date).getFullYear(),a=a.toString().slice(0,2),year=a+year),n=new Date(year,month),r=new Date,n.setMonth(n.getMonth()-1),n.setMonth(n.getMonth()+1,1),n>r):!1},function(e,t,r,n,a){if(!o[e])throw types=Object.keys(o),errstr='Unknown type for validation: "'+e+'". ',errstr+='Should be one of: "'+types.join('", "')+'"',errstr;return o[e](t,r,n,a)}}]).factory("_ValidateWatch",["_Validate",function(e){var t={};return t.cvc=function(t,r,n,a){a.paymentsTypeModel&&n.$watch(a.paymentsTypeModel,function(o,l){if(o!=l){var i=e(t,r.$modelValue,r,n,a);r.$setValidity(t,i)}})},function(e,r,n,a){return t[e]?t[e](e,r,n,a):void 0}}]).directive("paymentsValidate",["$window","_Validate","_ValidateWatch",function(e,t,r){return{restrict:"A",require:"ngModel",link:function(e,n,a,o){var l=a.paymentsValidate;r(l,o,e,a);var i=function(r){var n=t(l,r,o,e,a);return o.$setValidity(l,n),n?r:void 0};o.$formatters.push(i),o.$parsers.push(i)}}}]),angular.module("angularPayments").directive("stripeForm",["$window","$parse","Common",function(e,t,r){return _getDataToSend=function(e){var t=["number","expMonth","expYear","cvc","name","addressLine1","addressLine2","addressCity","addressState","addressZip","addressCountry"],r=function(e){return e.replace(/([A-Z])/g,function(e){return"_"+e.toLowerCase()})},n={};for(i in t)e.hasOwnProperty(t[i])&&(n[r(t[i])]=angular.copy(e[t[i]]));return n.number=(n.number||"").replace(/ /g,""),n},{restrict:"A",link:function(t,n,a){if(!e.Stripe)throw"stripeForm requires that you have stripe.js installed. Include https://js.stripe.com/v2/ into your html.";var o=angular.element(n);o.bind("submit",function(){expMonthUsed=t.expMonth?!0:!1,expYearUsed=t.expYear?!0:!1,expMonthUsed&&expYearUsed||(exp=r.parseExpiry(t.expiry),t.expMonth=exp.month,t.expYear=exp.year);var n=o.find("button");n.prop("disabled",!0),o.hasClass("ng-valid")?e.Stripe.createToken(_getDataToSend(t),function(){var e=arguments;t.$apply(function(){t[a.stripeForm].apply(t,e)}),n.prop("disabled",!1)}):(t.$apply(function(){t[a.stripeForm].apply(t,[400,{error:"Invalid form submitted."}])}),n.prop("disabled",!1)),t.expMonth=null,t.expYear=null})}}}]);
